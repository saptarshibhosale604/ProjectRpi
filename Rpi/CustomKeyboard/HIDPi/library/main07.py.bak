#!/usr/bin/env python
"""
README.md

main.py, working
- 10x5 keys
- layer 01 normal layer, short pressed, long pressed.
- home row mod keys
    - mod keys hold => Keyboard.hold_key
    - mod keys release => Keyboard.release
- funtion keys
- del key, special caps lock key
- gaming layer 
- exit python keyboard script key
- hold layer up => temp switch to layer 02,
    - releasing layer up => switch layer back to 01
- hold both layer up 01, layer up 02 => layer switch layer
- print combos
- print current layer

TODO
- B, media keys are not working, layer02
"""

import sys
import time
import glob
from gpiozero import DigitalOutputDevice, Button
from hidpi import Keyboard
from hidpi.keyboard_keys import *

# --------------------------------------------------
# Config
# --------------------------------------------------

scanDelay = 0.01
longPressTime = 0.3
# layerSwitchDelay = 0.3
layerSwitchDelay = 0.1

ROW_PINS_BCM = [26, 19, 13, 6]
COL_PINS_BCM = [21, 20, 16, 12, 1, 7, 8, 25, 24, 23]

matrixStateGamingLayer = [[False] * 10 for _ in range(4)]
pressTimeGamingLayer = [[0] * 10 for _ in range(4)]
maxHidKeysGamingLayer = 6

# --------------------------------------------------
# Layers
# --------------------------------------------------

# Layer 01, short pressed, Base layer
L1_SHORT = [
    ['Q','W','E','R','T','Y','U','I','O','P'],
    ['A','S','D','F','G','H','J','K','L','SEMICOLON'],
    ['Z','X','C','V','B','N','M','COMMA','PERIOD','SLASH'],
    ['ESC','SPACE','LAYER_UP','','','LAYER_DOWN','ENTER','BACKSPACE','','']
]

# Layer 01, long pressed, Number, Home row mods, Shortcut, Symbol
L1_LONG = [
    ['1','2','3','4','5','6','7','8','9','0'],
    ['LEFT_GUI','LEFT_ALT','LEFT_CTRL','LEFT_SHIFT','TAB','TAB',
     'RIGHT_SHIFT','RIGHT_CTRL','RIGHT_ALT','RIGHT_GUI'],
    ['FUNCTION_UNDO','FUNCTION_CUT','FUNCTION_COPY','FUNCTION_PASTE','BACKSLASH','QUOTE','MINUS','EQUAL','LEFT_BRACKET','RIGHT_BRACKET'],
    # ['ESC','SPACE','LAYER_CHANGE_LAYER','','','LAYER_CHANGE_LAYER','FUNCTION_ENTER','DEL','','']
    ['ESC','SPACE','LAYER_TEMP_LAYER_UP_01','','','LAYER_TEMP_LAYER_UP_02','FUNCTION_ENTER','DEL','','']
]

tempLayerUp = False # True: after layer up long key release, change layer back to original
isLayerTempLayerUp01Active = False
isLayerTempLayerUp02Active = False

FUNCTION_COMBOS = {
    'FUNCTION_UNDO': ('LEFT_CTRL', 'Z'),
    'FUNCTION_CUT': ('LEFT_CTRL', 'X'),
    'FUNCTION_COPY': ('LEFT_CTRL', 'C'),
    'FUNCTION_PASTE': ('LEFT_CTRL', 'V'),
    'FUNCTION_ENTER': ('LEFT_SHIFT', 'ENTER'),
    'FUNCTION_ZOOM_OUT': ('LEFT_CTRL', 'MINUS'),
    'FUNCTION_ZOOM_IN': ('LEFT_CTRL', 'EQUAL'),
}

SPECIAL_COMBOS = {
    'SPECIAL_CAPSLOCK': ('CHANGE_TO_LAYER_01', 'CAPSLOCK'),
}

# Layer 02, short pressed, Navigation, Shortcut, Symbol, Special test
L2_SHORT = [
    ['SPECIAL_TEST','','PAGE_UP','','','','','','',''],
    ['','HOME','PAGE_DOWN','END','','LEFT','DOWN','UP','RIGHT',''],
    ['','FUNCTION_CLOSE','SPECIAL_CAPSLOCK','','','','FUNCTION_ZOOM_OUT','FUNCTION_ZOOM_IN','',''],
    ['ESC','SPACE','LAYER_UP','','','LAYER_DOWN','ENTER','BACKSPACE','','']
]

# Layer 02, long pressed, Home row mods, one shot modifiers
L2_LONG = [
    # ['ONE_SHOT_MODIFIER_LEFT_GUI','ONE_SHOT_MODIFIER_LEFT_ALT','ONE_SHOT_MODIFIER_LEFT_CTRL','ONE_SHOT_MODIFIER_LEFT_SHIFT','TAB','TAB','ONE_SHOT_MODIFIER_RIGHT_SHIFT','ONE_SHOT_MODIFIER_RIGHT_CTRL','ONE_SHOT_MODIFIER_RIGHT_ALT','ONE_SHOT_MODIFIER_RIGHT_GUI'],
    ['','','','','','','','','',''],
    ['LEFT_GUI','LEFT_ALT','LEFT_CTRL','LEFT_SHIFT','TAB','TAB','RIGHT_SHIFT','RIGHT_CTRL','RIGHT_ALT','RIGHT_GUI'],
    ['','','','','','','GRAVE','PRINT_LEFT_ARROW','PRINT_RIGHT_ARROW','herere'],
    # ['ESC','SPACE','LAYER_CHANGE_LAYER','','','LAYER_CHANGE_LAYER','FUNCTION_ENTER','DEL','','']
    ['ESC','SPACE','LAYER_TEMP_LAYER_UP_01','','','LAYER_TEMP_LAYER_UP_02','FUNCTION_ENTER','DEL','','']
]

PRINT_COMBOS = {
    'PRINT_LEFT_ARROW': ('LEFT_SHIFT', 'COMMA', 'EQUAL'), # <=
    'PRINT_RIGHT_ARROW': ('EQUAL', 'LEFT_SHIFT', 'PERIOD'), # =>
}

# Layer 03, short pressed, FX / Media layer
L3_SHORT = [
    ['F1','F2','F3','F4','F5','F6','F7','F8','F9','F10'],
    ['F11','F12','','','','MEDIA_PREV','MEDIA_PLAY_PAUSE','MEDIA_MUTE','MEDIA_NEXT',''],
    ['','','','','','BRIGHTNESS_UP','VOLUME_UP','VOLUME_DOWN','BRIGHTNESS_DOWN',''],
    ['ESC','SPACE','LAYER_UP','','','LAYER_DOWN','ENTER','BACKSPACE','','']
]

# Layer 03, long pressed, Home row mods, one shot modifiers
L3_LONG = [
    ['','','','','','','','','',''],
    ['LEFT_GUI','LEFT_ALT','LEFT_CTRL','LEFT_SHIFT','TAB','TAB','RIGHT_SHIFT','RIGHT_CTRL','RIGHT_ALT','RIGHT_GUI'],
    ['','','','','','','','','',''],
    ['ESC','SPACE','LAYER_CHANGE_LAYER','','','LAYER_CHANGE_LAYER','FUNCTION_ENTER','DEL','','']
]


# Layer 04, Gaming layer
gamingLayerNumber = 4

KEY_MATRIX_LAYER_09 = [
    ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'SEMICOLON'],
    ['Z', 'X', 'C', 'V', 'B', 'N', 'M', 'COMMA', 'PERIOD', 'SLASH'],
    ['ESC', 'SPACE', 'LAYER_UP', '', '', 'LAYER_DOWN', 'ENTER', 'BACKSPACE', '', '']
]
# KEY_MATRIX_LAYER_04 = [
#     ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
#     ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'SEMICOLON'],
#     ['Z', 'X', 'C', 'V', 'B', 'N', 'M', 'COMMA', 'PERIOD', 'SLASH'],
#     ['ESC', 'SPACE', 'LAYER_UP', '', '', 'LAYER_DOWN', 'ENTER', 'BACKSPACE', '', '']
# ]

# Layer 05, Layer changing layer
layerChangeLayerNumber = 5

L5_SHORT = [
    ['LAYER_CHANGE_1','LAYER_CHANGE_2','LAYER_CHANGE_3','LAYER_CHANGE_4','LAYER_CHANGE_5','LAYER_CHANGE_6','LAYER_CHANGE_7','LAYER_CHANGE_8','LAYER_CHANGE_9','SPECIAL_QUIT_KEYBOARD'],
    ['','','','','','','LAYER_CHANGE_BASE','LAYER_CHANGE_GAMING','',''],
    ['','','','','','','','','',''],
    ['ESC', 'SPACE', 'LAYER_UP', '', '', 'LAYER_DOWN', 'ENTER', 'BACKSPACE', '', '']
]

# Layer 05
L5_LONG = [
    ['','','','','','','','','',''],
    ['LEFT_GUI','LEFT_ALT','LEFT_CTRL','LEFT_SHIFT','TAB','TAB','RIGHT_SHIFT','RIGHT_CTRL','RIGHT_ALT','RIGHT_GUI'],
    ['','','','','','','','','',''],
    ['ESC', 'SPACE', 'LAYER_UP', '', '', 'LAYER_DOWN', 'ENTER', 'BACKSPACE', '', '']
]

LAYER_SHORT_MAP = {
    1: L1_SHORT,
    2: L2_SHORT,
    3: L3_SHORT,
    4: KEY_MATRIX_LAYER_09,  # Gaming layer
    5: L5_SHORT,
}

LAYER_LONG_MAP = {
    1: L1_LONG,
    2: L2_LONG,
    3: L3_LONG,
    4: KEY_MATRIX_LAYER_09,  # Gaming layer
    5: L5_LONG,
}


# --------------------------------------------------
# Key maps
# --------------------------------------------------

keyMap = {k: v for k, v in globals().items() if k.startswith("KEY_")}
# print('keyMap start')
# print(keyMap)
# print('keyMap end')

modifierNames = {
    'LEFT_SHIFT','RIGHT_SHIFT','LEFT_CTRL','RIGHT_CTRL',
    'LEFT_ALT','RIGHT_ALT','LEFT_GUI','RIGHT_GUI'
}

# --------------------------------------------------
# State
# --------------------------------------------------

rowGpios = []
colGpios = []

pressed = set()

pressTime = {}
longSent = set()

currentLayer = 1
activeModifiers = 0
# print("activeModifiers = 0")

# --------------------------------------------------

def TestHid():
    if not glob.glob('/dev/hidg*'):
        raise RuntimeError("No HID device found")
    print("[INFO] HID ready")

def SetupMatrixKeyboard():
    for p in ROW_PINS_BCM:
        rowGpios.append(DigitalOutputDevice(p, initial_value=False))
    for p in COL_PINS_BCM:
        colGpios.append(Button(p, pull_up=False))
    print("[OK] GPIO ready")

def ScanMatrix():
    keys = set()
    for r, row in enumerate(rowGpios):
        row.on()
        time.sleep(0.0005)
        for c, col in enumerate(colGpios):
            if col.is_pressed:
                keys.add((r, c))
        row.off()
    return keys


def GetActiveKey(row, col, isLong):
    """Return key based on layer and press duration."""
    if currentLayer == 1:
        return (KEY_MATRIX_LAYER_01_LONG_PRESSED if isLong else
                KEY_MATRIX_LAYER_01_PRESSED)[row][col]
    return KEY_MATRIX_LAYER_09[row][col]
# --------------------------------------------------
# Core logic
# --------------------------------------------------

def HandleLayerXPress(key):
    global activeModifiers

    pressTime[key] = time.time()
    # print(f"HandleLayerXPress: key: {key}, pressTime[key]: {pressTime[key]}")
    longSent.discard(key)

isModifierHold = False

def HandleLayerXHold(key, LX_LONG):
    global activeModifiers
    global isLayerTempLayerUp01Active
    global isLayerTempLayerUp02Active
    global layerChangeLayerNumber
    global isModifierHold
    # print(f"HandleLayerXHold:")

    if key in longSent:
        return

    if time.time() - pressTime[key] >= longPressTime:
        r, c = key
        keyName = LX_LONG[r][c]
        
        # print(f"HandleLayerXHold longPressTime: key: {key}, keyName: {keyName}")
        # print(f"keyName: {keyName}")
        # print(f"keyName: {keyName}, keyNameFor: {keyNameFor}, keyNameBack: {keyNameBack}, ")
        if keyName.startswith('FUNCTION_'):
            function_combo = FUNCTION_COMBOS.get(keyName)
            if function_combo:
                mod_key, main_key = function_combo
                mod_val = keyMap[f"KEY_{mod_key}"]
                activeModifiers |= mod_val
                Keyboard.send_key(activeModifiers, keyMap[f"KEY_{main_key}"])
                activeModifiers = 0
                # print("activeModifiers = 0")
                print(f"[SEND] LONG FUNCTIONAL COMBO {keyName}")
                longSent.add(key)
                return

        elif keyName.startswith('LAYER_'):
            global tempLayerUp
            if keyName == 'LAYER_UP':
                SwitchLayer(1)
                return
            elif keyName == 'LAYER_DOWN':
                SwitchLayer(-1)
                return
            elif keyName.startswith('LAYER_TEMP_LAYER_UP_'):
                if keyName == 'LAYER_TEMP_LAYER_UP_01':
                    print(f"[HOLD] LONG {keyName}")
                    changeLayerTo = 2
                    tempLayerUp = True
                    isLayerTempLayerUp01Active = True
                elif keyName == 'LAYER_TEMP_LAYER_UP_02':
                    print(f"[HOLD] LONG {keyName}")
                    changeLayerTo = 2
                    tempLayerUp = True
                    isLayerTempLayerUp02Active = True

                # print(f"isLayerTempLayerUp02Active: {isLayerTempLayerUp02Active}")
                # print(f"isLayerTempLayerUp01Active: {isLayerTempLayerUp01Active}")

                if isLayerTempLayerUp01Active and isLayerTempLayerUp02Active:
                    print(f"[LAYER] LONG LAYER_CHANGE_LAYER") 
                    tempLayerUp = False
                    isLayerTempLayerUp01Active = False
                    isLayerTempLayerUp02Active = False
                    changeLayerTo = layerChangeLayerNumber

                SwitchLayer(delta=0, layerNumber=changeLayerTo)
                longSent.add(key)
                return
            elif keyName.startswith('LAYER_CHANGE_'):
                changeLayerTo = 0
                print(f"LAYER_CHANGE_: {keyName}")
                if keyName == 'LAYER_CHANGE_BASE':
                    changeLayerTo = 1
                elif keyName == 'LAYER_CHANGE_GAMING':
                    changeLayerTo = gamingLayerNumber
                elif keyName == 'LAYER_CHANGE_LAYER':
                    changeLayerTo = layerChangeLayerNumber
                else:
                    extractedLayerNum = int(keyName.split('_')[-1])
                    # print(f"extractedLayerNum: {extractedLayerNum}")
                    changeLayerTo = extractedLayerNum

                # print(f"SwitchLayer Send changeLayerTo: {changeLayerTo}")

                SwitchLayer(delta=0, layerNumber=changeLayerTo)
                longSent.add(key)
                return
        elif keyName == 'SPECIAL_QUIT_KEYBOARD':
            print("Quit key pressed. Exiting...")
            print(f"[SEND] LONG SPECIAL_QUIT_KEYBOARD")
            sys.exit(0)  # 0 for clean exit; use 1 for error code

        elif keyName.startswith('ONE_SHOT_MODIFIER_'):
            prefix = 'ONE_SHOT_MODIFIER_'
            get_mod_key = keyName[len(prefix):]
            print(f"get_mod_key: {get_mod_key}")
            mod_val = keyMap[f"KEY_{get_mod_key}"]
            activeModifiers |= mod_val

            Keyboard.send_key(activeModifiers, keyMap[f"KEY_NONE"])
            activeModifiers = 0
            # print("activeModifiers = 0")

            print(f"[SEND] LONG ONE_SHOT_MODIFIER {get_mod_key}")
            longSent.add(key)
            return

        elif keyName.startswith('PRINT_'):
            print(f"[SEND] LONG PRINT COMBO {keyName}")
            combo_keys = PRINT_COMBOS[keyName]
            current_modifiers = activeModifiers  # Preserve any existing modifiers
            
            for combo_key in combo_keys:
                if combo_key in modifierNames or combo_key == 'LEFT_SHIFT':
                    # Accumulate modifiers (don't send yet)
                    mod_val = keyMap[f"KEY_{combo_key}"]
                    current_modifiers |= mod_val
                    print(f"[MOD] PRINT_COMBO adding {combo_key}")
                else:
                    # Send non-modifier key WITH accumulated modifiers
                    print(f"[SEND] PRINT_COMBO {combo_key} (mods={current_modifiers})")
                    Keyboard.send_key(current_modifiers, keyMap[f"KEY_{combo_key}"])
                    current_modifiers = 0  # Clear after sending
            
            activeModifiers = 0  # Final cleanup
            # print("activeModifiers = 0")
            longSent.add(key)
            return


        if keyName in modifierNames:
            # activeModifiers |= keyMap[f"KEY_{keyName}"]
            # print(f"[MODIFIER] LONG {keyName}")
            # Keyboard.send_key(activeModifiers, keyMap[f"KEY_{keyName}"])
            # Keyboard.hold_key(activeModifiers, keyMap[f"KEY_{keyName}"])
            mod_val = keyMap[f"KEY_{keyName}"]
            activeModifiers |= mod_val
            print(f"[HOLD] MODIFIER {keyName}")
            Keyboard.hold_key(activeModifiers)  # Hold modifier without releasing
            isModifierHold = True
            longSent.add(key)
            return

        elif keyName:
            print(f"[SEND] LONG {keyName}")
            Keyboard.send_key(activeModifiers, keyMap[f"KEY_{keyName}"])
            # activeModifiers = 0

        longSent.add(key)

def HandleLayerXRelease(key, LX_SHORT, LX_LONG):
    global activeModifiers
    global keyMap
    global tempLayerUp
    global currentLayer
    global isLayerTempLayerUp01Active
    global isLayerTempLayerUp02Active
    global isModifierHold

    r, c = key
    keyName = LX_SHORT[r][c]

    if key in longSent:
        # print("print in release, in longsend")
        # print(f"isModifierHold: {isModifierHold}")

        if tempLayerUp:
            print(f"[RELEASE] LONG LAYER_TEMP_LAYER_UP_xx")
            currentLayer = 1
            tempLayerUp = False
            isLayerTempLayerUp01Active = False
            isLayerTempLayerUp02Active = False

        if isModifierHold:
            isModifierHold = False
            # print(f"[RELEASE] MODIFIER {keyName}")
            # Keyboard.release_keys()
            # activeModifiers = 0

            keyNameLong = LX_LONG[r][c]
            # print(f"keyName: {keyName}")
            # print(f"keyNameLong: {keyNameLong}")

            if keyNameLong in modifierNames:
                print(f"[RELEASE] MODIFIER {keyName}")
                Keyboard.release_keys()
                activeModifiers = 0
                # print("activeModifiers = 0")

        return

    print(f"HandleLayerXRelease keyName: {keyName}")
    if not keyName:
        return

    if keyName == 'SPECIAL_TEST':
        print("SPECIAL_TEST")
        # temp_mod_key = 'LEFT_GUI'
        # mod_val = keyMap[f"KEY_{temp_mod_key}"]
        # activeModifiers |= mod_val
        #
        # tempKeyName = 'NONE'
        # Keyboard.send_key(activeModifiers, keyMap[f"KEY_{tempKeyName}"])
        # print("SPECIAL_TEST send")
        return

    elif keyName == 'SPECIAL_QUIT_KEYBOARD':
        print("Quit key pressed. Exiting...")
        print(f"[SEND] SHORT SPECIAL_QUIT_KEYBOARD")
        sys.exit(0)  # 0 for clean exit; use 1 for error code

    # ['LAYER_CHANGE_1','LAYER_CHANGE_2','LAYER_CHANGE_3','LAYER_CHANGE_4','LAYER_CHANGE_5','LAYER_CHANGE_6','LAYER_CHANGE_7','LAYER_CHANGE_8','LAYER_CHANGE_9','SPECIA_CHANGE__QUIT_KEYBOARD'],
    # ['','','','','','','LAYER_CHANGE_BASE','LAYER_CHANGE_GAMING','',''],

    elif keyName.startswith('LAYER_'):
        
        if keyName == 'LAYER_UP':
            SwitchLayer(1)
            return
        elif keyName == 'LAYER_DOWN':
            SwitchLayer(-1)
            return
        elif keyName.startswith('LAYER_CHANGE_'):
            changeLayerTo = 0
            print(f"LAYER_CHANGE_: {keyName}")
            if keyName == 'LAYER_CHANGE_BASE':
                changeLayerTo = 1
            elif keyName == 'LAYER_CHANGE_GAMING':
                changeLayerTo = gamingLayerNumber
            elif keyName == 'LAYER_CHANGE_LAYER':
                changeLayerTo = layerChangeLayerNumber
            else:
                extractedLayerNum = int(keyName.split('_')[-1])
                # print(f"extractedLayerNum: {extractedLayerNum}")
                changeLayerTo = extractedLayerNum

            # print(f"SwitchLayer Send changeLayerTo: {changeLayerTo}")

            SwitchLayer(delta=0, layerNumber=changeLayerTo)
            return

    elif keyName.startswith('FUNCTION_'):
        # print("inside long FUNCTION_")
        function_combo = FUNCTION_COMBOS.get(keyName)
        if function_combo:
            mod_key, main_key = function_combo
            mod_val = keyMap[f"KEY_{mod_key}"]
            activeModifiers |= mod_val
            Keyboard.send_key(activeModifiers, keyMap[f"KEY_{main_key}"])
            activeModifiers = 0
            # print("activeModifiers = 0")
            print(f"[SEND] SHORT FUNCTIONAL COMBO {keyName}")
            longSent.add(key)
            return

    elif keyName.startswith('SPECIAL_'):
        # print("inside long SPECIAL_") 
        special_combo = SPECIAL_COMBOS.get(keyName) 
        if special_combo:
            special_feature, main_key = special_combo
            Keyboard.send_key(activeModifiers, keyMap[f"KEY_{main_key}"])
            activeModifiers = 0
            # print("activeModifiers = 0")

            if special_feature == 'CHANGE_TO_LAYER_01':
                SwitchLayer(-1)

            print(f"[SEND] SHORT SPECIAL COMBO {keyName}")
            # longSent.add(key)
            return


    print(f"[SEND] SHORT {keyName}")
    
    # keyMap = keyMap[f"KEY_{keyName}"]
    # print(f"keyMap[KEY_keyName]: {keyMap}")

    Keyboard.send_key(activeModifiers, keyMap[f"KEY_{keyName}"])
    # activeModifiers = 0

maxLayer = 5


def PrintLayerShort(layer_num):
    layerShort = LAYER_SHORT_MAP.get(layer_num)

    if not layerShort:
        print(f"[LAYER] No SHORT layout for layer {layer_num}")
        return

    print(f"\n[LAYER {layer_num} SHORT]")

    for row in layerShort:
        # print(" | ".join(key if key else "----" for key in row))
        print(" | ".join(key if key else "-" for key in row))

    layerLong = LAYER_LONG_MAP.get(layer_num)

    if not layerLong:
        print(f"[LAYER] No LONG layout for layer {layer_num}")
        return

    print(f"\n[LAYER {layer_num} LONG]")

    for row in layerLong:
        # print(" | ".join(key if key else "----" for key in row))
        print(" | ".join(key if key else "-" for key in row))

    print("\n")

def SwitchLayer(delta = 0, layerNumber = 0):
    global currentLayer
    # print(f"SwitchLayer Receive delta: {delta}, layerNumber: {layerNumber}")
    if layerNumber != 0:
        currentLayer = layerNumber 
        # print(f"[LAYER] Non-Delta Switched to {currentLayer}")
        print(f"[LAYER] Direct Switched to layer {currentLayer}")
    else:
        currentLayer = max(1, min(maxLayer, currentLayer + delta)) # print(f"[LAYER] Delta Switched to {currentLayer}")
        print(f"[LAYER] Delta Switched to layer {currentLayer}")

    PrintLayerShort(currentLayer)
    time.sleep(layerSwitchDelay)

def UpdateKeyboardGamingLayer():
    """Update HID state from matrix."""
    global currentLayer

    pressedKeys = []
    now = time.time()
    currentPressed = ScanMatrix()

    for r in range(4):
        for c in range(10):
            isPressed = (r, c) in currentPressed
            wasPressed = matrixStateGamingLayer[r][c]

            if isPressed and not wasPressed:
                pressTimeGamingLayer[r][c] = now

            if not isPressed and wasPressed:
                print(f"[RELEASE] Layer {currentLayer} -> ({r},{c})")
                pressTimeGamingLayer[r][c] = 0

            if isPressed:
                isLong = (now - pressTimeGamingLayer[r][c]) > longPressTime
                keyName = GetActiveKey(r, c, isLong)

                if keyName == 'LAYER_UP':
                    SwitchLayer(1)
                    return
                elif keyName == 'LAYER_DOWN':
                    SwitchLayer(-1)
                    return

                if not wasPressed:
                    pressType = "LONG" if isLong else "SHORT"
                    print(f"[PRESS] Layer {currentLayer} | {pressType} | Key: {keyName}")

                # if keyName == 'LAYER_DOWN':
                #     currentLayer = max(1, currentLayer - 1)
                #     print(f"[LAYER] Switched to Layer {currentLayer}")
                #     continue
                #
                # Keyboard.send_key(activeModifiers, keyMap[f"KEY_{main_key}"])
                # keyCode = keyMap.get(keyName, 0)
                keyCode = keyMap[f"KEY_{keyName}"]
                if keyCode:
                    pressedKeys.append(keyCode)

            matrixStateGamingLayer[r][c] = isPressed

    if pressedKeys:
        Keyboard.hold_key(0, *pressedKeys[:maxHidKeysGamingLayer])
    else:
        Keyboard.release_keys()


# --------------------------------------------------
import time

lastPrintTimeIntervalPrint = 0.0
printIntervalIntervalPrint = 2.0  # seconds

def PrintCurrentLayer():
    global lastPrintTimeIntervalPrint, printIntervalIntervalPrint
    currentTimeIntervalPrint = time.time()
        
    if currentTimeIntervalPrint - lastPrintTimeIntervalPrint >= printIntervalIntervalPrint:
        print(f"main loop currentLayer: {currentLayer}")
        lastPrintTimeIntervalPrint = currentTimeIntervalPrint  # Reset for next interval

def MainLoop():
    global pressed
    global activeModifiers

    print("[INFO] Keyboard started")

    while True:

        now = ScanMatrix()

        # PrintCurrentLayer()
        
        # ---------------- Layer 1 ----------------
        if currentLayer == 1:
            for key in now - pressed:
                # print(f"[L{currentLayer} PRESS] {key}")
                print(f"[L{currentLayer} PRESS] key: {key} activeModifiers: {activeModifiers} ")
                
                HandleLayerXPress(key)

            for key in now:
                HandleLayerXHold(key, L1_LONG)

            for key in pressed - now:
                HandleLayerXRelease(key, L1_SHORT, L1_LONG)

            pressed = now
            time.sleep(scanDelay)

        # ---------------- Layer 2 ----------------
        elif currentLayer == 2:
            for key in now - pressed:
                # print(f"[L{currentLayer} PRESS] {key}")
                print(f"[L{currentLayer} PRESS] key: {key} activeModifiers: {activeModifiers} ")
                HandleLayerXPress(key)

            for key in now:
                HandleLayerXHold(key, L2_LONG)

            for key in pressed - now:
                # HandleLayerXRelease(key, L2_SHORT)
                HandleLayerXRelease(key, L2_SHORT, L2_LONG)

            pressed = now
            time.sleep(scanDelay)

        # ---------------- Layer 3 ----------------
        elif currentLayer == 3:
            for key in now - pressed:
                # print(f"[L{currentLayer} PRESS] {key}")
                print(f"[L{currentLayer} PRESS] key: {key} activeModifiers: {activeModifiers} ")
                HandleLayerXPress(key)

            for key in now:
                HandleLayerXHold(key, L3_LONG)

            for key in pressed - now:
                # HandleLayerXRelease(key, L3_SHORT)
                HandleLayerXRelease(key, L3_SHORT, L3_LONG)

            pressed = now
            time.sleep(scanDelay)


        # ---------------- Gaming layer ----------------
        elif currentLayer == gamingLayerNumber:
            UpdateKeyboardGamingLayer()

        # ---------------- Layer Change Layer ----------------
        elif currentLayer == layerChangeLayerNumber:
            for key in now - pressed:
                # print(f"[L{currentLayer} PRESS] {key}")
                print(f"[L{currentLayer} PRESS] key: {key} activeModifiers: {activeModifiers} ")
                HandleLayerXPress(key)

            # for key in now:
            #     HandleLayerXHold(key, L5_LONG)

            for key in pressed - now:
                # HandleLayerXRelease(key, L5_SHORT)
                HandleLayerXRelease(key, L5_SHORT, L5_LONG)

            pressed = now
            time.sleep(scanDelay)

# --------------------------------------------------
def WelcomeScript():
    print("WELCOME SSB, To Custom Keyboard.")
    print("For quiting the keyboard script: Layer 02, hold, Z")


if __name__ == "__main__":
    WelcomeScript()
    TestHid()
    SetupMatrixKeyboard()
    MainLoop()

